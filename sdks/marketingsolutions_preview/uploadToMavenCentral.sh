#!/bin/bash

set -e

# See https://central.sonatype.org/publish/generate-portal-token/ to generate it
if [[ -z "$SONATYPE_USERNAME" ]]; then
  echo error: empty SONATYPE_USERNAME
  exit 1
fi
# See https://central.sonatype.org/publish/generate-portal-token/ to generate it
if [[ -z "$SONATYPE_PASSWORD" ]]; then
  echo error: empty SONATYPE_PASSWORD
  exit 1
fi

VERSION="0.0.250919"

./gradlew clean build publishMavenJavaPublicationToMavenLocal -x test

POM_FILE=build/publications/mavenJava/criteo-api-marketingsolutions-sdk-0.0.250919.pom
mv build/publications/mavenJava/pom-default.xml "$POM_FILE"
mv build/publications/mavenJava/pom-default.xml.asc "$POM_FILE".asc
md5sum < "$POM_FILE" | cut -d' ' -f1 > "$POM_FILE".md5
sha1sum < "$POM_FILE" | cut -d' ' -f1 > "$POM_FILE".sha1

for JAR in build/libs/*jar; do
  md5sum < "$JAR" | cut -d' ' -f1 > "$JAR".md5
  sha1sum < "$JAR" | cut -d' ' -f1 > "$JAR".sha1
done

BUNDLE_DIR=temp_for_upload_to_mvn_central
rm -rf $BUNDLE_DIR
GROUPID_TO_PATH=$(echo -n "com.criteo" | tr ':' '/')
FULL_BUNDLE_DIR="$BUNDLE_DIR/$GROUPID_TO_PATH/0.0.250919"
mkdir -p "$FULL_BUNDLE_DIR"

cp build/libs/* "$FULL_BUNDLE_DIR"
cp "$POM_FILE"* "$FULL_BUNDLE_DIR"

pushd "$BUNDLE_DIR"
BUNDLE=bundle-"$VERSION".tar.gz
tar zcf "$BUNDLE" *

TOKEN=$(echo -n "$SONATYPE_USERNAME:$SONATYPE_PASSWORD" | base64)

curl \
  -H "Authorization: Bearer $TOKEN" \
  --form bundle=@"$BUNDLE" \
  -XPOST 'https://central.sonatype.com/api/v1/publisher/upload?publishingType=AUTOMATIC'

# To check the status afterwards:
# ID=<output of previous curl command>
# curl --request POST \
#   --header "Authorization: Bearer $TOKEN" \
#     "https://central.sonatype.com/api/v1/publisher/status?id=$ID" \
#     | jq
